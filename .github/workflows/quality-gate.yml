name: Quality Gate
on:
  pull_request:
  push:
    branches: [main, develop]

env:
  NODE_VERSION: '22'
  FORCE_COLOR: 1

jobs:
  quality-checks:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    strategy:
      fail-fast: true
      matrix:
        workspace: [backend, frontend]
        
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with: 
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ matrix.workspace }}/package-lock.json'
          
      - name: ğŸ”§ Install dependencies
        working-directory: ${{ matrix.workspace }}
        run: |
          npm ci --prefer-offline --no-audit --no-progress
        
      - name: ğŸ” TypeScript Strict Check
        working-directory: ${{ matrix.workspace }}
        run: |
          echo "ğŸ” Running strict TypeScript checks..."
          npm run typecheck || npm run type-check
          echo "âœ… TypeScript check passed with ZERO errors!"
        
      - name: ğŸ“ ESLint Strict Check  
        working-directory: ${{ matrix.workspace }}
        run: |
          echo "ğŸ“ Running ESLint with ZERO warnings policy..."
          npm run lint
          echo "âœ… ESLint passed with ZERO warnings!"
          
      - name: ğŸ§ª Run Tests
        working-directory: ${{ matrix.workspace }}
        run: |
          if [ -f "package.json" ] && npm run | grep -q "test"; then
            echo "ğŸ§ª Running tests..."
            npm test
            echo "âœ… All tests passed!"
          else
            echo "âš ï¸ No test script found in ${{ matrix.workspace }}"
          fi
          
      - name: ğŸ—ï¸ Build Check
        working-directory: ${{ matrix.workspace }}
        run: |
          if [ -f "package.json" ] && npm run | grep -q "build"; then
            echo "ğŸ—ï¸ Testing build..."
            npm run build
            echo "âœ… Build successful!"
          else
            echo "âš ï¸ No build script found in ${{ matrix.workspace }}"
          fi

  security-audit:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: quality-checks
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with: 
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ğŸ”’ Security Audit
        run: |
          echo "ğŸ”’ Running security audit..."
          cd backend && npm audit --audit-level=moderate
          cd ../frontend && npm audit --audit-level=moderate
          echo "âœ… Security audit passed!"
          
  integration-ready:
    runs-on: ubuntu-latest
    needs: [quality-checks, security-audit]
    if: success()
    
    steps:
      - name: ğŸ‰ Quality Gate PASSED
        run: |
          echo "ğŸ‰ ALL QUALITY GATES PASSED!"
          echo "âœ… TypeScript: ZERO errors"
          echo "âœ… ESLint: ZERO warnings"  
          echo "âœ… Tests: ALL passing"
          echo "âœ… Build: Successful"
          echo "âœ… Security: No vulnerabilities"
          echo ""
          echo "ğŸš€ Ready for staging deployment!"
