# Database Schema

## Overview

This document describes the database schema for the College Whisper application.

## Tables

### whispers

Stores all whispers (posts) in the system.

| Column | Type | Description |
|--------|------|-------------|
| id | SERIAL PRIMARY KEY | Unique identifier |
| content | TEXT NOT NULL | The whisper content |
| emotion | VARCHAR(20) | Emotion associated with the whisper |
| zone | VARCHAR(50) | Campus zone where the whisper was posted |
| created_at | TIMESTAMPTZ DEFAULT NOW() | Creation timestamp |
| updated_at | TIMESTAMPTZ DEFAULT NOW() | Last update timestamp |
| expires_at | TIMESTAMPTZ | When the whisper should expire |
| guest_id | VARCHAR(36) | ID of the guest user who created the whisper |
| is_ai_generated | BOOLEAN DEFAULT FALSE | Whether the whisper was generated by AI |
| is_deleted | BOOLEAN DEFAULT FALSE | Soft delete flag |
| emotional_tone | VARCHAR(32) | Specific emotional tone (sadness, gratitude, etc.) |
| whisper_type | VARCHAR(32) | Type of whisper (vent, question, poetic, etc.) |
| soft_title | VARCHAR(64) | Optional title for the whisper |
| ai_reply_status | VARCHAR(16) | Status of AI reply generation |

### reactions

Tracks user reactions to whispers.

| Column | Type | Description |
|--------|------|-------------|
| id | SERIAL PRIMARY KEY | Unique identifier |
| whisper_id | INTEGER REFERENCES whispers(id) | The whisper being reacted to |
| guest_id | VARCHAR(36) | ID of the guest user who reacted |
| emoji | VARCHAR(8) | The emoji reaction |
| created_at | TIMESTAMPTZ DEFAULT NOW() | When the reaction was created |

### whisper_embeddings

Stores vector embeddings for whisper content to enable semantic search.

| Column | Type | Description |
|--------|------|-------------|
| whisper_id | INTEGER PRIMARY KEY REFERENCES whispers(id) | Reference to the whisper |
| embedding | VECTOR(1536) | The vector embedding of the whisper content |
| created_at | TIMESTAMPTZ DEFAULT NOW() | When the embedding was generated |

### reports

Tracks user reports of inappropriate content.

| Column | Type | Description |
|--------|------|-------------|
| id | SERIAL PRIMARY KEY | Unique identifier |
| whisper_id | INTEGER REFERENCES whispers(id) | The reported whisper |
| reporter_guest_id | VARCHAR(36) | ID of the reporting user |
| reason | TEXT | Reason for the report |
| status | VARCHAR(20) DEFAULT 'pending' | Status of the report |
| created_at | TIMESTAMPTZ DEFAULT NOW() | When the report was created |
| resolved_at | TIMESTAMPTZ | When the report was resolved |
| resolved_by | INTEGER REFERENCES admin_users(id) | Admin who resolved the report |

### replies

Stores replies to whispers.

| Column | Type | Description |
|--------|------|-------------|
| id | SERIAL PRIMARY KEY | Unique identifier |
| whisper_id | INTEGER REFERENCES whispers(id) | The parent whisper |
| content | TEXT NOT NULL | The reply content |
| guest_id | VARCHAR(36) | ID of the guest user who replied |
| is_ai_generated | BOOLEAN DEFAULT FALSE | Whether the reply was generated by AI |
| created_at | TIMESTAMPTZ DEFAULT NOW() | When the reply was created |
| is_deleted | BOOLEAN DEFAULT FALSE | Soft delete flag |

### banned_users

Tracks banned users and their ban details.

| Column | Type | Description |
|--------|------|-------------|
| id | SERIAL PRIMARY KEY | Unique identifier |
| guest_id | VARCHAR(36) | ID of the banned guest |
| reason | TEXT | Reason for the ban |
| banned_by | INTEGER REFERENCES admin_users(id) | Admin who issued the ban |
| banned_until | TIMESTAMPTZ | When the ban expires (NULL for permanent) |
| created_at | TIMESTAMPTZ DEFAULT NOW() | When the ban was created |

### ai_reply_jobs

Tracks AI reply generation jobs.

| Column | Type | Description |
|--------|------|-------------|
| id | SERIAL PRIMARY KEY | Unique identifier |
| whisper_id | INTEGER REFERENCES whispers(id) | The whisper to generate a reply for |
| status | VARCHAR(20) DEFAULT 'pending' | Job status |
| attempts | INTEGER DEFAULT 0 | Number of attempts made |
| last_attempt_at | TIMESTAMPTZ | When the last attempt was made |
| error | TEXT | Error message if the job failed |
| created_at | TIMESTAMPTZ DEFAULT NOW() | When the job was created |
| updated_at | TIMESTAMPTZ DEFAULT NOW() | When the job was last updated |

### moderation_logs

Logs moderation actions taken by admins.

| Column | Type | Description |
|--------|------|-------------|
| id | SERIAL PRIMARY KEY | Unique identifier |
| admin_id | INTEGER REFERENCES admin_users(id) | Admin who performed the action |
| action_type | VARCHAR(50) | Type of moderation action |
| target_type | VARCHAR(50) | Type of target (e.g., 'whisper', 'user') |
| target_id | INTEGER | ID of the target |
| details | JSONB | Additional details about the action |
| created_at | TIMESTAMPTZ DEFAULT NOW() | When the action was taken |

### ban_history

Historical record of all user bans.

| Column | Type | Description |
|--------|------|-------------|
| id | SERIAL PRIMARY KEY | Unique identifier |
| guest_id | VARCHAR(36) | ID of the banned guest |
| admin_id | INTEGER REFERENCES admin_users(id) | Admin who issued the ban |
| reason | TEXT | Reason for the ban |
| banned_at | TIMESTAMPTZ DEFAULT NOW() | When the ban was issued |
| unbanned_at | TIMESTAMPTZ | When the ban was lifted |
| was_revoked | BOOLEAN DEFAULT FALSE | Whether the ban was manually revoked |
| revoked_by | INTEGER REFERENCES admin_users(id) | Admin who revoked the ban |
| revoked_reason | TEXT | Reason for revoking the ban |

### otp_tokens

Stores one-time passwords for admin authentication.

| Column | Type | Description |
|--------|------|-------------|
| id | SERIAL PRIMARY KEY | Unique identifier |
| email | VARCHAR(255) | Admin email |
| token | VARCHAR(6) | The OTP token |
| used | BOOLEAN DEFAULT FALSE | Whether the token has been used |
| expires_at | TIMESTAMPTZ | When the token expires |
| created_at | TIMESTAMPTZ DEFAULT NOW() | When the token was created |

## Table Relationships

- One-to-many: `whisper` has many `reactions`
- One-to-many: `whisper` has many `replies`
- One-to-one: `whisper` has one `embedding`
- One-to-many: `whisper` has many `reports`
- One-to-one: `whisper` has one `ai_reply_job`

## Indexes

- `whispers(created_at DESC)` - For fetching and sorting recent whispers
- `whispers(zone, created_at DESC)` - For zone-based queries and sorting
- `whispers(guest_id, created_at DESC)` - For fetching and sorting a user's whispers
- `reactions(whisper_id, guest_id)` - For checking user reactions and counting
- `reports(status, created_at)` - For fetching pending reports
- `banned_users(guest_id, banned_until)` - For checking user ban status
- `whisper_embeddings(embedding)` - Vector index for semantic search
- `ai_reply_jobs(status, created_at)` - For managing AI reply jobs

## Data Retention

- Whispers and their associated data are automatically deleted after their `expires_at` timestamp
- Deleted content is retained for 30 days before permanent deletion
- Audit logs are kept for 1 year
- Old logs and reports may be archived or deleted after a retention period
- Bans are permanent unless manually reversed

## Backup Strategy

- Daily automated backups with 7-day retention
- Point-in-time recovery (PITR) enabled
- Backups are encrypted and stored in a geographically separate region

## See Also

- [API Reference](./API_REFERENCE.md)
- [Security Guide](./SECURITY_GUIDE.md)
- [Performance Guide](./PERFORMANCE_GUIDE.md)
